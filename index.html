<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medi√ß√£o de Rodas ‚Äî Formul√°rio</title>
  <style>
    :root {
      /* Paleta */
      --bg: #f2f3f5; --card: #ffffff; --ink: #1b1f25; --muted: #6b7280;
      --border: #c7cbd1; --grid: #e3e6eb; --primary: #0f6cbd; --primary-weak: rgba(15,108,189,0.14);
      /* Sem√°foros */
      --green: #1b5e20; --amber: #bf7b00; --red: #b71c1c; --neutral: #7a7f87;
      /* Espa√ßamentos */
      --space-1: 6px; --space-2: 10px; --space-3: 14px; --space-4: 20px;
      --radius-6: 6px; --radius-8: 8px; --radius-10: 10px; --shadow-1: 0 2px 10px rgba(18, 23, 31, 0.08);
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; color: var(--ink); background: var(--bg); line-height: 1.35; padding: var(--space-4); }
    body.modal-open { overflow: hidden; }

    .header { display:flex; align-items:center; gap:var(--space-2); margin-bottom:var(--space-2); flex-wrap:wrap; }
    h1 { font-size:1.35rem; margin:0; letter-spacing:.2px; }
    .subtitle { color:var(--muted); margin:4px 0 var(--space-3) 0; }

    .info-btn {
      display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:50%;
      border:1px solid var(--border); background:var(--card); color:var(--ink); cursor:pointer; font-size:18px;
      transition: box-shadow 0.2s, border-color 0.2s, transform .06s;
    }
    .info-btn:hover { border-color: var(--primary); box-shadow: 0 0 0 6px var(--primary-weak); }
    .info-btn:active { transform: scale(.98); }

    .traffic-counters { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px; background:var(--card); border:1px solid var(--border); font-weight:600; font-size:.90rem; color:var(--ink); box-shadow:var(--shadow-1); }
    .chip.score { font-weight:800; }
    .dot { width:10px; height:10px; border-radius:50%; }
    .dot.green{background:var(--green);} .dot.amber{background:var(--amber);} .dot.red{background:var(--red);} .dot.neutral{background:var(--neutral);} .dot.empty{background:#9aa0a6;}

    .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-10); box-shadow:var(--shadow-1); padding:var(--space-3); max-width:100%; }
    .field { display:flex; flex-direction:column; gap:var(--space-1); }
    label { font-size:.86rem; color:var(--ink); font-weight:600; }

    .input, select { width:100%; padding:9px 12px; border:1px solid var(--border); border-radius:var(--radius-8); background:#fbfcff; color:var(--ink);
      outline:none; transition: box-shadow .2s, border-color .2s, background .15s; }
    .input:hover, select:hover { background:#f5f7fb; }
    .input:focus, select:focus { border-color:var(--primary); box-shadow:0 0 0 6px var(--primary-weak); background:#fff; }

    .meta-grid { display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:var(--space-3); margin-bottom:var(--space-3); }
    @media (max-width:980px){ .meta-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (max-width:560px){ .meta-grid{ grid-template-columns:1fr; } }

    .table-wrap { width:100%; border:1px solid var(--border); border-radius:var(--radius-10); overflow:hidden; background:var(--card); }
    table { width:100%; border-collapse:collapse; background:var(--card); table-layout:fixed; }
    thead th { background:#e9edf3; color:#0d1b2a; text-align:center; padding:var(--space-2); border-bottom:1px solid var(--border); font-weight:700; white-space:normal; word-break:break-word; letter-spacing:.15px; font-size:.80rem; }
    tbody th, tbody td { border-bottom:1px solid var(--grid); padding:var(--space-2); text-align:center; vertical-align:middle; color:var(--ink); }
    tbody tr:nth-child(even){ background:#f7f9fc; }

    .th-desc{
      display:block;
      font-weight:600;
      font-size:.72rem;
      color:#334155;
      line-height:1.1;
      margin-top:2px;
    }


    .col-truque, .col-eixo, .col-roda, .col-roda-trem { width:90px; }

    .measure-input { width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:var(--radius-8); background:#fbfcff; color:var(--ink);
      font:inherit; transition:border-color .2s, box-shadow .2s, background .15s; }
    .measure-input:hover { background:#f5f7fb; }
    .measure-input:focus { border-color:var(--primary); box-shadow:0 0 0 6px var(--primary-weak); background:#fff; }

    .cell-status { display:flex; align-items:center; gap:8px; justify-content:center; }
    .badge { width:10px; height:10px; border-radius:50%; border:1px solid rgba(0,0,0,0.15); box-shadow:inset 0 0 0 2px rgba(255,255,255,0.35); }
    .ok-badge{background:var(--green);} .warn-badge{background:var(--amber);} .bad-badge{background:var(--red);}
    .status-ok{ border-color:var(--green)!important; box-shadow:0 0 0 6px rgba(27,94,32,0.15); }
    .status-warn{ border-color:var(--amber)!important; box-shadow:0 0 0 6px rgba(191,123,0,0.18); }
    .status-bad{ border-color:var(--red)!important; box-shadow:0 0 0 6px rgba(183,28,28,0.18); }

    .actions { display:flex; gap:var(--space-2); margin-top:var(--space-3); flex-wrap:wrap; }
    .btn { border:1px solid var(--border); padding:10px 14px; border-radius:var(--radius-8); cursor:pointer; font-weight:700; background:var(--card); color:var(--ink);
      transition: transform .06s, box-shadow .2s, border-color .2s, background .15s; }
    .btn:hover{ border-color:var(--primary); box-shadow:0 0 0 6px var(--primary-weak); background:#f7f9fc; }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
    .btn-primary:hover{ box-shadow:0 0 0 6px var(--primary-weak); background:#0c5ba0; }
    .btn-danger{ background:var(--red); color:#fff; border-color:var(--red); }
    .btn-ok{ background:var(--green); color:#fff; border-color:var(--green); }
    .btn-outline{ background:var(--card); color:var(--primary); border-color:var(--primary); }

    .btn:disabled { opacity: .55; cursor: not-allowed; box-shadow: none !important; }

    .note{ margin-top:var(--space-2); font-size:.9rem; color:var(--muted); }
    .alert{ margin-top:var(--space-2); padding:var(--space-2); border-radius:var(--radius-8); display:none; font-size:.95rem; border:1px solid var(--border); background:var(--card); }
    .alert.success{ border-color:var(--green); box-shadow:0 0 0 6px rgba(27,94,32,0.12); }

    .derived-wrap{ margin-top:var(--space-3); border:1px solid var(--border); border-radius:var(--radius-10); box-shadow:var(--shadow-1); overflow:hidden; background:var(--card); }
    .derived-table th, .derived-table td{ padding:var(--space-2); border-bottom:1px solid var(--grid); text-align:center; }
    .derived-table thead th{ background:#e9edf3; font-weight:700; color:#0d1b2a; }
    .small{ font-size:.9rem; color:var(--muted); }

    /* Resultados derivados: destaque quando estiver FORA */
    .derived-out {
      background: #ffebee;
      color: #b71c1c;
      font-weight: 700;
    }

    .modal-backdrop { position:fixed; inset:0; background:rgba(18,23,31,0.45); display:none; align-items:center; justify-content:center; padding:20px; z-index:1000; }
    .modal-backdrop.open { display:flex; }
    .modal { background:var(--card); border-radius:12px; max-width:820px; width:100%; box-shadow:0 16px 64px rgba(18,23,31,0.35); border:1px solid var(--border); outline:none; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); }
    .modal-title { font-weight:800; letter-spacing:.2px; }
    .modal-body { padding:14px 16px; display:grid; gap:12px; color:var(--ink); max-height:65vh; overflow:auto; }
    .modal-footer { padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; }
    .close-btn { border:1px solid var(--red); background:transparent; color:var(--red); font-weight:700; cursor:pointer; padding:8px 12px; border-radius:var(--radius-8); }
    .section-title { font-weight:800; margin:4px 0; }
    .list { margin:0; padding-left:18px; }
    .list li { margin:4px 0; }

    @media print {
      body{ padding:0; background:#fff; color:#111; }
      .no-print{ display:none!important; }
      .print-section{ padding:16px 24px; }
      .print-title{ font-size:1.25rem; font-weight:700; margin-bottom:8px; }
      .print-sub{ color:#555; margin-bottom:12px; }
      .print-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-bottom:12px; }
      .print-card{ border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:12px; }
      .print-table{ width:100%; border-collapse:collapse; }
      .print-table th, .print-table td{ border:1px solid #ddd; padding:6px 8px; font-size:12px; text-align:center; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      .print-table thead th{ background:#f3f3f3; }
      .chips{ display:flex; gap:8px; flex-wrap:wrap; }
      .chip{ border:1px solid #ddd; border-radius:999px; padding:4px 10px; font-weight:700; font-size:12px; }

      .pdf-ok   { background:#e8f5e9; color:#1b5e20; }
      .pdf-warn { background:#fff8e1; color:#8a5a00; }
      .pdf-bad  { background:#ffebee; color:#b71c1c; }
      .pdf-empty{ background:#fafafa; color:#777; }
      .status-dot{ display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:4px; border:1px solid rgba(0,0,0,.2); }
      .status-dot.ok{ background:#1b5e20; } .status-dot.warn{ background:#bf7b00; } .status-dot.bad{ background:#b71c1c; } .status-dot.empty{ background:#9aa0a6; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Formul√°rio de Medi√ß√£o de Rodas</h1>
    <button id="tolerancesBtn" class="info-btn no-print" aria-label="Ver toler√¢ncias" title="Ver toler√¢ncias">‚ÑπÔ∏è</button>

    <div id="counterBar" class="traffic-counters" aria-live="polite">
      <span class="chip"><span class="dot green"></span> Verde: <span id="cntGreen">0</span></span>
      <span class="chip"><span class="dot amber"></span> Amarelo: <span id="cntAmber">0</span></span>
      <span class="chip"><span class="dot red"></span> Vermelho: <span id="cntRed">0</span></span>
      <span class="chip"><span class="dot empty"></span> Vazios: <span id="cntEmpty">0</span></span>

      <span class="chip score" title="Nota final calculada (0‚Äì100)">
        <span id="scoreDot" class="dot empty"></span>
        Nota final: <span id="finalScore">‚Äî</span>
      </span>
    </div>
  </div>

  <p class="subtitle">Ferramenta de registro de medi√ß√µes de rodas. Usada para opera√ß√µes de medi√ß√µes preventivas, usinagens e trocas de roda</p>

  <form id="inspectionForm" class="card" autocomplete="off">
    <div class="meta-grid">
      <div class="field">
        <label for="unidade">Unidade</label>
        <select id="unidade" name="unidade" required>
          <option value="" disabled selected>Selecione...</option>
          <option>VT</option><option>VQ</option><option>ON</option><option>VM</option><option>MB</option>
        </select>
      </div>

      <div class="field">
        <label for="frota">Frota</label>
        <select id="frota" name="frota" required>
          <option value="" disabled selected>Selecione a Unidade primeiro...</option>
        </select>
      </div>

      <div class="field">
        <label for="trem">Trem</label>
        <select id="trem" name="trem" required>
          <option value="" disabled selected>Selecione...</option>
        </select>
      </div>

      <div class="field">
        <label for="data">Data</label>
        <input class="input" type="date" id="data" name="data" required />
      </div>

      <div class="field">
        <label for="km">Quilometragem</label>
        <input class="input" type="text" id="km" name="km" inputmode="numeric" pattern="\d*" placeholder="Ex.: 120345" required />
      </div>

      <div class="field">
        <label for="os">Ordem de Servi√ßo</label>
        <input class="input" type="text" id="os" name="os" inputmode="numeric" pattern="\d*" placeholder="Ex.: 123456" required />
      </div>

      <div class="field">
        <label for="operacao">Opera√ß√£o</label>
        <select id="operacao" name="operacao" required>
          <option value="" disabled selected>Selecione...</option>
          <option>Medi√ß√£o</option><option>Usinagem</option><option>Troca Roda meia vida</option><option>Troca Roda</option>
        </select>
      </div>

      <div class="field">
        <label for="tipo">Tipo</label>
        <select id="tipo" name="tipo" required>
          <option value="" disabled selected>Selecione...</option>
          <option>Torno</option><option>Calipri</option><option>Perfilometro</option>
        </select>
      </div>

      <div class="field">
        <label for="sentido">Sentido</label>
        <select id="sentido" name="sentido" required>
          <option value="" disabled selected>Selecione...</option>
          <option>Cabe√ßa</option><option>Parte de tr√°s</option>
        </select>
      </div>
    </div>

    <div class="table-wrap">
      <table aria-label="Tabela de medi√ß√µes por truque/eixo/roda">
        <thead>
          <tr>
            <th class="col-truque">Truque</th>
            <th class="col-eixo">Eixo</th>
            <th class="col-roda">Roda<br>(ref. Torno)</th>
            <th class="col-roda-trem">Roda Trem</th>
            <th>D<br><span class="th-desc">Di√¢metro</span></th>>
            <th>sD<br><span class="th-desc">Largura do friso</span></th>
            <th>sH<br><span class="th-desc">Altura do friso</span></th>
            <th>qR<br><span class="th-desc">√Çngulo face ativa</span></th>
            <th>FR<br><span class="th-desc">Ovaliza√ß√£o</span></th>
            <th>V<br><span class="th-desc">Empeno</span></th>
          </tr>
        </thead>
        <tbody id="measureBody"></tbody>
      </table>
    </div>

    <div class="actions">
      <button type="button" class="btn btn-ok no-print" id="downloadCsvBtn">Baixar CSV</button>
      <button type="button" class="btn btn-outline no-print" id="generatePdfBtn">Gerar PDF</button>
      <button type="reset" class="btn btn-danger no-print">Limpar</button>

      <button
        type="button"
        class="btn btn-outline no-print"
        id="rodaNovaBtn"
        disabled
        title="Dispon√≠vel apenas para opera√ß√£o: Troca Roda"
      >Roda Nova</button>

      <button type="submit" class="btn btn-primary no-print">Enviar</button>
    </div>

    <div id="alertSuccess" class="alert success" role="status" aria-live="polite"></div>

    <div class="derived-wrap">
      <table class="derived-table" aria-label="Resultados derivados">
        <thead>
          <tr><th>Regra</th><th>Refer√™ncia</th><th>Valor</th><th>Status</th></tr>
        </thead>
        <tbody id="derivedBody"></tbody>
      </table>
      <p class="small">Obs.: DÃÑ_eixo = m√©dia de D(E) e D(D). M√©dia do truque = m√©dia dos dois eixos.</p>
    </div>
  </form>

  <div id="tolerancesModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="tolTitle">
    <div class="modal" role="document" tabindex="-1">
      <div class="modal-header">
        <div id="tolTitle" class="modal-title">Toler√¢ncias consideradas</div>
        <button id="tolCloseTop" class="info-btn" aria-label="Fechar">‚úñÔ∏è</button>
      </div>
      <div id="tolBody" class="modal-body"></div>
      <div class="modal-footer"><button id="tolClose" class="close-btn">Fechar</button></div>
    </div>
  </div>

  <script>
    const MOTOR_TRUQUES = ["M1","NM","M2"];
    const REBOQUE_TRUQUE = "NP";

    const FROTA_BY_UNIDADE = { VT:["Citadis 402"], VQ:["S400"], VM:["Frota P"], ON:["S7000","S8900"], MB:["S1000","S2000"] };

    const LIMITS = { D:{min:530.0,max:null}, sD:{min:17.0,max:null}, sH:{min:18.0,max:27.5}, qR:{min:2.5,max:7.0}, FR:{min:null,max:1.5}, V:{min:null,max:1.0} };
    const SEMAPHORE = {
      D:{ red:v=>v<530.0, yellow:v=>v<532.0, green:v=>v>=532.0 },
      sD:{ red:v=>v<17.0, yellow:v=>v<18.5, green:v=>v>=18.5 },
      sH:{ red:v=>(v<18.0||v>27.5), yellow:v=>(v<19.0||v>26.5), green:v=>(v<=26.5) },
      qR:{ red:v=>v<2.5, yellow:v=>v<3.5, green:v=>v>=4.5 },
      V:{ red:v=>v>1.0, yellow:v=>v>0.8, green:v=>v<=0.8 },
      FR:{ red:v=>v>1.5, yellow:v=>v>1.0, green:v=>v<=1.0 },
    };

    const DERIVED_LIMITS = { DsD:{min:null,max:2.0}, DDEM:{min:null,max:1.0}, DDER:{min:null,max:2.0}, DDTM:{min:null,max:2.0}, DDTR:{min:null,max:6.0}, DDT:{min:null,max:10.0} };

    /* MAPEAMENTO Roda Trem */
    const RODA_TREM_MAP = {
      "Cabe√ßa": {
        M1:{1:{E:1,D:2}, 2:{E:3,D:4}},
        NM:{1:{E:1,D:2}, 2:{E:3,D:4}},
        NP:{1:{E:2,D:1}, 2:{E:4,D:3}},
        M2:{1:{E:2,D:1}, 2:{E:4,D:3}},
      },
      "Parte de tr√°s": {
        M1:{1:{E:2,D:1}, 2:{E:4,D:3}},
        NM:{1:{E:2,D:1}, 2:{E:4,D:3}},
        NP:{1:{E:1,D:2}, 2:{E:3,D:4}},
        M2:{1:{E:1,D:2}, 2:{E:3,D:4}},
      }
    };
    function getRodaTrem(truque,eixo,roda,sentido){
      if(!sentido) return "";
      const val=RODA_TREM_MAP?.[sentido]?.[truque]?.[eixo]?.[roda];
      return (val===undefined)?"":String(val);
    }

    /* ORDEM VISUAL das medi√ß√µes ‚Äî FR antes de V */
    const measureFields = ["D","sD","sH","qR","FR","V"];

    const COMBINATIONS = [
      {truque:"M1",eixo:1,roda:"E"},{truque:"M1",eixo:1,roda:"D"},{truque:"M1",eixo:2,roda:"E"},{truque:"M1",eixo:2,roda:"D"},
      {truque:"NM",eixo:1,roda:"E"},{truque:"NM",eixo:1,roda:"D"},{truque:"NM",eixo:2,roda:"E"},{truque:"NM",eixo:2,roda:"D"},
      {truque:"NP",eixo:1,roda:"E"},{truque:"NP",eixo:1,roda:"D"},{truque:"NP",eixo:2,roda:"E"},{truque:"NP",eixo:2,roda:"D"},
      {truque:"M2",eixo:1,roda:"E"},{truque:"M2",eixo:1,roda:"D"},{truque:"M2",eixo:2,roda:"E"},{truque:"M2",eixo:2,roda:"D"},
    ];

    const tbody = document.getElementById("measureBody");
    const derivedBody = document.getElementById("derivedBody");
    const alertSuccess = document.getElementById("alertSuccess");
    const scoreEl = document.getElementById("finalScore");
    const scoreDotEl = document.getElementById("scoreDot");

    function fillFrotaOptions(unidade){
      const frotaSel=document.getElementById("frota");
      frotaSel.innerHTML="";
      const first=document.createElement("option"); first.value=""; first.disabled=true; first.selected=true;
      first.textContent = unidade ? "Selecione..." : "Selecione a Unidade primeiro...";
      frotaSel.appendChild(first);
      if(!unidade) return;
      (FROTA_BY_UNIDADE[unidade]||[]).forEach(model=>{
        const opt=document.createElement("option"); opt.value=model; opt.textContent=model; frotaSel.appendChild(opt);
      });
    }

    function fillTremOptions(){
      const tremSel=document.getElementById("trem");
      for(let n=101;n<=132;n++){
        const opt=document.createElement("option");
        opt.value=String(n); opt.textContent=String(n);
        tremSel.appendChild(opt);
      }
    }

    function createCellWithStatus(inputEl){
      const wrap=document.createElement("div"); wrap.className="cell-status";
      const badge=document.createElement("span"); badge.className="badge";
      wrap.appendChild(inputEl); wrap.appendChild(badge);
      return {wrap,badge};
    }

    function createRow(truque,eixo,roda){
      const tr=document.createElement("tr");

      const thTruque=document.createElement("th"); thTruque.className="col-truque"; thTruque.textContent=truque; tr.appendChild(thTruque);
      const thEixo=document.createElement("th"); thEixo.className="col-eixo"; thEixo.textContent=eixo; tr.appendChild(thEixo);
      const thRoda=document.createElement("th"); thRoda.className="col-roda"; thRoda.textContent=roda; tr.appendChild(thRoda);

      const thRodaTrem=document.createElement("th"); thRodaTrem.className="col-roda-trem";
      const sentidoSel=document.getElementById("sentido").value;
      thRodaTrem.textContent=getRodaTrem(truque,Number(eixo),roda,sentidoSel);
      tr.appendChild(thRodaTrem);

      measureFields.forEach(key=>{
        const td=document.createElement("td");
        const inp=document.createElement("input");
        inp.type="number"; inp.inputMode="decimal"; inp.className="measure-input";
        inp.name=`${truque}-${eixo}-${roda}-${key}`;
        inp.placeholder=key; inp.step="0.01"; inp.min="0";
        const {wrap,badge}=createCellWithStatus(inp);
        td.appendChild(wrap); tr.appendChild(td);

      });

      return tr;
    }

    function initTable(){
      COMBINATIONS.forEach(c=>tbody.appendChild(createRow(c.truque,c.eixo,c.roda)));
    }

    function bindMeasureTableAutoUpdates() {
      const handler = (e) => {
        const target = e.target;

        if (!(target instanceof HTMLInputElement)) return;
        if (!target.classList.contains("measure-input")) return;

        const key = target.name.split("-").slice(-1)[0];
        const val = target.value === "" ? null : Number(target.value);

        const level = classifyIndividual(key, val);

        const badge = target.closest(".cell-status")?.querySelector(".badge");
        if (badge) applySemaphore(target, badge, level);

        computeAndRenderDerived();
        updateCounters();
        updateFinalScore();
      };

      // input = em tempo real (digitando/colando)
      tbody.addEventListener("input", handler);

      // change = fallback para alguns casos de autofill/blur
      tbody.addEventListener("change", handler);
    }

    function classifyIndividual(key,val){
      if(val===null||isNaN(val)) return null;
      const rule=SEMAPHORE[key]; if(!rule) return null;
      if(rule.red(val)) return "red";
      if(rule.green(val)) return "green";
      if(rule.yellow(val)) return "yellow";
      return "neutral";
    }

    function applySemaphore(inputEl,badgeEl,level){
      inputEl.classList.remove("status-ok","status-warn","status-bad");
      badgeEl.classList.remove("ok-badge","warn-badge","bad-badge");
      if(level===null||level==="neutral") return;
      if(level==="green"){ inputEl.classList.add("status-ok"); badgeEl.classList.add("ok-badge"); }
      else if(level==="yellow"){ inputEl.classList.add("status-warn"); badgeEl.classList.add("warn-badge"); }
      else if(level==="red"){ inputEl.classList.add("status-bad"); badgeEl.classList.add("bad-badge"); }
    }

    function inRange(val,min,max){
      if(val===null||isNaN(val)) return null;
      if(min!==null && val<min) return false;
      if(max!==null && val>max) return false;
      return true;
    }
    function checkDerived(val,lim){ return inRange(val,lim.min,lim.max); }

    function collectData(){
      const meta = {
        unidade:document.getElementById("unidade").value,
        frota:document.getElementById("frota").value,
        trem:document.getElementById("trem").value,
        data:document.getElementById("data").value,
        km:Number(document.getElementById("km").value),
        os:document.getElementById("os").value.trim(),
        operacao:document.getElementById("operacao").value,
        tipo:document.getElementById("tipo").value,
        sentido:document.getElementById("sentido").value,
      };
      const rows=[];
      [...tbody.querySelectorAll("tr")].forEach(tr=>{
        const ths=tr.querySelectorAll("th");
        const truqueEl=ths[0], eixoEl=ths[1], rodaEl=ths[2], rodaTremEl=ths[3];
        const inputs=tr.querySelectorAll("input.measure-input");
        const row={
          truque:truqueEl.textContent,
          eixo:Number(eixoEl.textContent),
          roda:rodaEl.textContent,
          rodaTrem:(rodaTremEl.textContent?.trim()===""?null:Number(rodaTremEl.textContent))
        };
        inputs.forEach(inp=>{
          const key=inp.name.split("-").slice(-1)[0];
          const val=inp.value===""?null:Number(inp.value);
          row[key]=val;
          row[`${key}_level`]=classifyIndividual(key,val);
        });
        rows.push(row);
      });
      return { meta, medidas: rows };
    }

    function nestByTruqueEixoRoda(data){
      const byTr={};
      data.medidas.forEach(r=>{
        byTr[r.truque]??={};
        byTr[r.truque][r.eixo]??={};
        byTr[r.truque][r.eixo][r.roda]={ D:r.D, sD:r.sD, sH:r.sH, qR:r.qR, V:r.V, FR:r.FR };
      });
      return byTr;
    }

    function avg(...nums){
      const vals=nums.filter(v=>v!==null && !isNaN(v));
      if(!vals.length) return null;
      return vals.reduce((a,b)=>a+b,0)/vals.length;
    }
    function diff(a,b){
      if(a===null||b===null||isNaN(a)||isNaN(b)) return null;
      return Math.abs(a-b);
    }

    function computeDerived(byTr){
      const results=[];
      Object.keys(byTr).forEach(tr=>{
        Object.keys(byTr[tr]).forEach(eixoStr=>{
          const eixo=Number(eixoStr);
          const E=byTr[tr][eixo]["E"]; const Dd=byTr[tr][eixo]["D"];
          if(E && Dd){
            const dsD=diff(E.sD,Dd.sD);
            const okDsD=checkDerived(dsD,DERIVED_LIMITS.DsD);
            results.push({regra:"DsD",ref:`${tr} / eixo ${eixo}`,valor:dsD,status:okDsD});

            const dDiff=diff(E.D,Dd.D);
            if(MOTOR_TRUQUES.includes(tr)){
              const ok=checkDerived(dDiff,DERIVED_LIMITS.DDEM);
              results.push({regra:"DDEM",ref:`${tr} / eixo ${eixo}`,valor:dDiff,status:ok});
            } else if(tr===REBOQUE_TRUQUE){
              const ok=checkDerived(dDiff,DERIVED_LIMITS.DDER);
              results.push({regra:"DDER",ref:`${tr} / eixo ${eixo}`,valor:dDiff,status:ok});
            }
          }
        });
      });

      Object.keys(byTr).forEach(tr=>{
        const e1=byTr[tr][1], e2=byTr[tr][2];
        if(e1 && e2){
          const D_e1=avg(e1["E"]?.D??null,e1["D"]?.D??null);
          const D_e2=avg(e2["E"]?.D??null,e2["D"]?.D??null);
          const ddt=diff(D_e1,D_e2);
          if(MOTOR_TRUQUES.includes(tr)){
            const ok=checkDerived(ddt,DERIVED_LIMITS.DDTM);
            results.push({regra:"DDTM",ref:`${tr}`,valor:ddt,status:ok});
          } else if(tr===REBOQUE_TRUQUE){
            const ok=checkDerived(ddt,DERIVED_LIMITS.DDTR);
            results.push({regra:"DDTR",ref:`${tr}`,valor:ddt,status:ok});
          }
        }
      });

      const motorMeans=MOTOR_TRUQUES.map(tr=>{
        const e1=byTr[tr]?.[1], e2=byTr[tr]?.[2];
        if(!e1||!e2) return {tr,mean:null};
        const D_e1=avg(e1["E"]?.D??null,e1["D"]?.D??null);
        const D_e2=avg(e2["E"]?.D??null,e2["D"]?.D??null);
        return {tr,mean:avg(D_e1,D_e2)};
      });
      const validMeans=motorMeans.filter(m=>m.mean!==null);
      if(validMeans.length>=2){
        let maxPairDiff=0;
        for(let i=0;i<validMeans.length;i++){
          for(let j=i+1;j<validMeans.length;j++){
            const d=diff(validMeans[i].mean,validMeans[j].mean);
            if(d!==null && d>maxPairDiff) maxPairDiff=d;
          }
        }
        const ok=checkDerived(maxPairDiff,DERIVED_LIMITS.DDT);
        results.push({regra:"DDT",ref:MOTOR_TRUQUES.join(" vs "),valor:maxPairDiff,status:ok});
      }
      return results;
    }

    function renderDerived(results){
      derivedBody.innerHTML="";
      results.forEach(r=>{
        const tr=document.createElement("tr");

        // üî¥ Destaque visual quando estiver FORA
        if (r.status === false) tr.classList.add("derived-out");

        const tdReg=document.createElement("td");
        const tdRef=document.createElement("td");
        const tdVal=document.createElement("td");
        const tdSt=document.createElement("td");

        const abbr=document.createElement("abbr");
        const titles={
          DsD:"DsD = Diferen√ßa de largura do friso no mesmo eixo (‚â§ 2,0 mm)",
          DDEM:"DDEM = Diferen√ßa de di√¢metro no mesmo eixo motor (‚â§ 1,0 mm)",
          DDER:"DDER = Diferen√ßa de di√¢metro no mesmo eixo reboque (‚â§ 2,0 mm)",
          DDTM:"DDTM = Diferen√ßa entre eixos do mesmo truque motor (‚â§ 2,0 mm)",
          DDTR:"DDTR = Diferen√ßa entre eixos do truque reboque (NP) (‚â§ 6,0 mm)",
          DDT:"DDT = Diferen√ßa entre truques motores (m√°x. par-a-par ‚â§ 10,0 mm)"
        };
        abbr.title=titles[r.regra] || "";
        abbr.textContent=r.regra;

        tdReg.appendChild(abbr);
        tdRef.textContent=r.ref;
        tdVal.textContent=(r.valor===null||isNaN(r.valor))?"‚Äî":r.valor.toFixed(2);

        const badge=document.createElement("span");
        badge.className="badge "+(r.status===true?"ok-badge":"bad-badge");
        const label=document.createElement("span");
        label.textContent=r.status===null ? "sem dados" : (r.status ? "OK" : "fora");

        tdSt.appendChild(badge);
        tdSt.appendChild(document.createTextNode(" "));
        tdSt.appendChild(label);

        tr.appendChild(tdReg); tr.appendChild(tdRef); tr.appendChild(tdVal); tr.appendChild(tdSt);
        derivedBody.appendChild(tr);
      });
    }

    function computeAndRenderDerived(){
      const data=collectData();
      const byTr=nestByTruqueEixoRoda(data);
      const derived=computeDerived(byTr);
      renderDerived(derived);
    }

    function computeCounters(data){
      const counters={green:0,yellow:0,red:0,neutral:0,empty:0};
      data.medidas.forEach(r=>{
        measureFields.forEach(k=>{
          const val=r[k];
          const level=classifyIndividual(k,val);
          if(level===null) counters.empty++;
          else if(level==="green") counters.green++;
          else if(level==="yellow") counters.yellow++;
          else if(level==="red") counters.red++;
          else counters.neutral++;
        });
      });
      return counters;
    }

    function updateCounters(){
      const data=collectData();
      const c=computeCounters(data);
      document.getElementById("cntGreen").textContent=c.green;
      document.getElementById("cntAmber").textContent=c.yellow;
      document.getElementById("cntRed").textContent=c.red;
      document.getElementById("cntEmpty").textContent=c.empty;
    }

    function isMetaFilled(meta){
      return meta.unidade && meta.frota && meta.trem && meta.data &&
             !isNaN(meta.km) && meta.os && meta.operacao && meta.tipo && meta.sentido;
    }

    /* =========================
       L√ìGICA DE NOTA FINAL
       ========================= */
    const IND_YELLOW_ALPHA = 0.5;
    const IND_TOTAL_FIXED = 96;
    const RED_CRITICAL_P = 0.07;
    const DER_TOTAL_FIXED = 20;

    function computeIndividualScore(data) {
      const c = computeCounters(data);
      const basePoints = (c.green + c.neutral) + (IND_YELLOW_ALPHA * c.yellow);
      const baseScore = 100 * (basePoints / IND_TOTAL_FIXED);
      const criticalFactor = Math.pow(1 - RED_CRITICAL_P, c.red);
      const score = baseScore * criticalFactor;
      return Math.max(0, Math.min(100, score));
    }

    function buildExpectedDerivedKeys() {
      const expected = [];
      const truques = ["M1", "NM", "NP", "M2"];
      const motorTruques = ["M1", "NM", "M2"];

      truques.forEach(tr => {
        [1, 2].forEach(eixo => {
          expected.push({ regra: "DsD", ref: `${tr} / eixo ${eixo}` });
          if (motorTruques.includes(tr)) expected.push({ regra: "DDEM", ref: `${tr} / eixo ${eixo}` });
          else if (tr === "NP") expected.push({ regra: "DDER", ref: `${tr} / eixo ${eixo}` });
        });
      });

      motorTruques.forEach(tr => expected.push({ regra: "DDTM", ref: `${tr}` }));
      expected.push({ regra: "DDTR", ref: `NP` });
      return expected;
    }

    const EXPECTED_DERIVED = buildExpectedDerivedKeys();

    function computeDerivedScore(data) {
      const byTr = nestByTruqueEixoRoda(data);
      const derivedResults = computeDerived(byTr);

      const map = new Map();
      derivedResults.forEach(r => map.set(`${r.regra}|${r.ref}`, r.status));

      let okCount = 0;
      EXPECTED_DERIVED.forEach(k => {
        const st = map.get(`${k.regra}|${k.ref}`);
        if (st === true) okCount += 1;
      });

      const score = 100 * (okCount / DER_TOTAL_FIXED);
      return Math.max(0, Math.min(100, score));
    }

    function computeFinalScore(data) {
      const ind = computeIndividualScore(data);
      const der = computeDerivedScore(data);
      const final = (2 * ind + 1 * der) / 3;
      return Math.max(0, Math.min(100, Math.round(final)));
    }

    function updateFinalScore() {
      const data = collectData();
      const metaOK = isMetaFilled(data.meta);

      if (!metaOK) {
        scoreEl.textContent = "‚Äî";
        scoreDotEl.className = "dot empty";
        return;
      }

      const score = computeFinalScore(data);
      scoreEl.textContent = String(score);
      scoreDotEl.className = "dot " + (score >= 85 ? "green" : (score >= 70 ? "amber" : "red"));
    }

    /* =========================
       MODAL TOLER√ÇNCIAS
       ========================= */
    const tolModal=document.getElementById("tolerancesModal");
    const tolBody=document.getElementById("tolBody");
    const tolOpenBtn=document.getElementById("tolerancesBtn");
    const tolCloseBtn=document.getElementById("tolClose");
    const tolCloseTopBtn=document.getElementById("tolCloseTop");
    const tolDialog=tolModal.querySelector(".modal");

    function formatLimitText(min,max){
      const fmt=(n)=>(n===null||n===undefined)?null:n.toFixed(1).replace('.',',');
      const fmin=fmt(min), fmax=fmt(max);
      if(fmin&&fmax) return `${fmin} a ${fmax}`;
      if(fmin&&!fmax) return `‚â• ${fmin}`;
      if(!fmin&&fmax) return `‚â§ ${fmax}`;
      return `‚Äî`;
    }

    function buildTolerancesHtml(){
      const unitsNote = document.createElement("p");
      unitsNote.className = "small";
      unitsNote.textContent = "Unidades: mm";

      /* =========================
         INDIVIDUAIS
         ========================= */
      const sec1Title = document.createElement("div");
      sec1Title.className = "section-title";
      sec1Title.textContent = "Toler√¢ncias individuais (hard limits)";

      const ul1 = document.createElement("ul");
      ul1.className = "list";

      const IND_DESC = {
        D:  "Di√¢metro da roda",
        sD: "Largura do friso",
        sH: "Altura do friso",
        qR: "√Çngulo de face ativa",
        FR: "Ovaliza√ß√£o",
        V:  "Empeno"
      };

      Object.keys(LIMITS).forEach(k=>{
        const li = document.createElement("li");

        const strong = document.createElement("strong");
        strong.textContent = k;

        const desc = document.createElement("span");
        desc.textContent = ` ‚Äî ${IND_DESC[k]}: ${formatLimitText(LIMITS[k].min, LIMITS[k].max)}`;

        li.appendChild(strong);
        li.appendChild(desc);
        ul1.appendChild(li);
      });

      /* =========================
         DERIVADAS
         ========================= */
      const sec2Title = document.createElement("div");
      sec2Title.className = "section-title";
      sec2Title.textContent = "Toler√¢ncias derivadas / calculadas";

      const ul2 = document.createElement("ul");
      ul2.className = "list";

      const DER_DESC = {
        DsD:  "Diferen√ßa de largura do friso no mesmo eixo",
        DDEM: "Diferen√ßa de di√¢metro no mesmo eixo motor",
        DDER: "Diferen√ßa de di√¢metro no mesmo eixo reboque",
        DDTM: "Diferen√ßa entre eixos do mesmo truque motor",
        DDTR: "Diferen√ßa entre eixos do truque reboque (NP)",
        DDT:  "Diferen√ßa m√°xima entre truques motores (par-a-par)"
      };

      Object.keys(DERIVED_LIMITS).forEach(k=>{
        const li = document.createElement("li");

        const strong = document.createElement("strong");
        strong.textContent = k;

        const desc = document.createElement("span");
        desc.textContent = ` ‚Äî ${DER_DESC[k]}: ${formatLimitText(DERIVED_LIMITS[k].min, DERIVED_LIMITS[k].max)}`;

        li.appendChild(strong);
        li.appendChild(desc);
        ul2.appendChild(li);
      });

      /* =========================
         WRAP FINAL
         ========================= */
      const wrap = document.createElement("div");
      wrap.appendChild(sec1Title);
      wrap.appendChild(ul1);
      wrap.appendChild(sec2Title);
      wrap.appendChild(ul2);
      wrap.appendChild(unitsNote);

      return wrap;
    }

    function openTolModal(){
      tolBody.innerHTML="";
      tolBody.appendChild(buildTolerancesHtml());
      tolModal.classList.add("open");
      tolModal.setAttribute("aria-hidden","false");
      document.body.classList.add("modal-open");
      tolDialog.focus();
    }
    function closeTolModal(){
      tolModal.classList.remove("open");
      tolModal.setAttribute("aria-hidden","true");
      document.body.classList.remove("modal-open");
      tolOpenBtn.focus();
    }
    tolOpenBtn.addEventListener("click",openTolModal);
    tolCloseBtn?.addEventListener("click",closeTolModal);
    tolCloseTopBtn?.addEventListener("click",closeTolModal);
    tolModal.addEventListener("click",(e)=>{ if(e.target===tolModal) closeTolModal(); });
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && tolModal.classList.contains("open")) closeTolModal(); });

    function buildExportBaseName(meta){
      const safe = (s) => String(s ?? "")
        .trim()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")   // tira acentos
        .replace(/[\\/:*?"<>|]/g,"-")                     // evita chars inv√°lidos em arquivo
        .replace(/\s+/g,"_");                             // espa√ßos -> underscore

      const unidade = safe(meta.unidade);
      const data = safe(meta.data);                       // yyyy-mm-dd (do input date)
      const trem = safe(meta.trem);
      const os   = safe(meta.os);
      const op   = safe(meta.operacao);

      const base = [unidade,data, trem, os, op].filter(Boolean).join("_");
      return base || "export";
    }

    function buildEmailSubject(meta){
      const base = buildExportBaseName(meta); // Data_Trem_OS_Operacao
      const unidadeTxt = meta.unidade ? `Unidade ${meta.unidade}` : "Unidade ‚Äî";
      const tremTxt = meta.trem ? `Trem  ${meta.trem}` : "Trem ‚Äî";
      return `${base} - ${unidadeTxt} - ${tremTxt}`;
    }


    /* =========================
       CSV (SEM BLOQUEIO)
       ========================= */
    function toCSV(data){
      const SEP = ";";
      const headers=["Unidade","Frota","Data","Quilometragem","Ordem de Servi√ßo","Opera√ß√£o","Tipo","Sentido","Trem","Truque","Eixo","Roda(ref. Torno)","Roda Trem","D","sD","sH","qR","FR","V"];

      const escapeCSV = (v) => {
	if (v === null || v === undefined || (typeof v === "number" && isNaN(v))) return "";
	
	// ‚úÖ se for n√∫mero (ou string num√©rica), trocar "." por "," na parte decimal
	const isNumeric =
	(typeof v === "number") ||
	(typeof v === "string" && v.trim() !== "" && !isNaN(Number(v.replace(",", "."))));
	
	let s = String(v);
	
	if (isNumeric) {
	  // garante formato com ponto e depois troca para v√≠rgula
	  const num = (typeof v === "number") ? v : Number(s.replace(",", "."));
	  s = String(num).replace(".", ",");
	}

	// escapa aspas e envolve em aspas (robusto para ; e quebras de linha)
	s = s.replace(/"/g, '""');
	return `"${s}"`;
                };

      const lines=[];
      lines.push(headers.map(escapeCSV).join(SEP));	

      data.medidas.forEach(r=>{
          const row = [
            data.meta.unidade,
            data.meta.frota,
            data.meta.data,
            data.meta.km,
            data.meta.os,
            data.meta.operacao,
            data.meta.tipo,
            data.meta.sentido,
            data.meta.trem,

            r.truque,
            r.eixo,
            r.roda,
            r.rodaTrem ?? "",

            r.D,
            r.sD,
            r.sH,
            r.qR,
            r.FR,
            r.V
          ];

        lines.push(row.map(escapeCSV).join(SEP));
      });
      return lines.join("\n");
    }

    function downloadCSV(data){
      const base = buildExportBaseName(data.meta);
      const filename = `${base}.csv`;

      const csv=toCSV(data);
      const blob = new Blob(["\ufeff", csv], { type: "text/csv;charset=utf-8" });
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }

    /* =========================
       PDF (destaque em vermelho nos derivados "fora")
       ========================= */
    function generatePdfReport(){
      const data=collectData();
      const base = buildExportBaseName(data.meta);
      const counters=computeCounters(data);
      const byTr=nestByTruqueEixoRoda(data);
      const derived=computeDerived(byTr);

      const now=new Date();
      const fmt=(n)=>(n===null||n===undefined||isNaN(n))?"‚Äî":Number(n).toFixed(2);

      const measuresHeader=`
        <tr>
          <th>Truque</th><th>Eixo</th><th>Roda(ref. Torno)</th><th>Roda Trem</th>
          <th>D</th><th>sD</th><th>sH</th><th>qR</th><th>FR</th><th>V</th>
        </tr>`;

      const levelClass=(lvl)=>{ if(lvl==="green") return "pdf-ok"; if(lvl==="yellow") return "pdf-warn"; if(lvl==="red") return "pdf-bad"; return "pdf-empty"; };
      const dotClass=(lvl)=>{ if(lvl==="green") return "ok"; if(lvl==="yellow") return "warn"; if(lvl==="red") return "bad"; return "empty"; };

      const measuresRows=data.medidas.map(r=>{
        const cells=measureFields.map(k=>{
          const lvl=classifyIndividual(k,r[k]);
          const cls=levelClass(lvl);
          const dcls=dotClass(lvl);
          const val=fmt(r[k]);
          return `<td class="${cls}"><span class="status-dot ${dcls}"></span>${val}</td>`;
        }).join("");
        return `<tr><td>${r.truque}</td><td>${r.eixo}</td><td>${r.roda}</td><td>${r.rodaTrem ?? "‚Äî"}</td>${cells}</tr>`;
      }).join("");

      // ‚úÖ AQUI: class no <tr> quando status === false
      const derivedRows = derived.map(d => {
        const rowCls = (d.status === false) ? ' class="pdf-derived-out"' : '';
        return `
          <tr${rowCls}>
            <td>${d.regra}</td>
            <td>${d.ref}</td>
            <td>${(d.valor===null||isNaN(d.valor)) ? "‚Äî" : fmt(d.valor)}</td>
            <td>${d.status===null ? "sem dados" : (d.status ? "OK" : "fora")}</td>
          </tr>
        `;
      }).join("");

      const legendaHtml = `
        <div class="print-card">
          <div><strong>Legenda e defini√ß√µes das siglas</strong></div>
          <div class="legend" style="margin-top:8px">
            <div><strong>DsD</strong> ‚Äî Diferen√ßa de largura do friso no mesmo eixo: <em>DsD = |sD(E) ‚àí sD(D)|</em> (‚â§ 2,0 mm)</div>
            <div><strong>DDEM</strong> ‚Äî Diferen√ßa de di√¢metro no mesmo eixo (truque motor): <em>DDEM = |D(E) ‚àí D(D)|</em> (‚â§ 1,0 mm)</div>
            <div><strong>DDER</strong> ‚Äî Diferen√ßa de di√¢metro no mesmo eixo (truque reboque NP): <em>DDER = |D(E) ‚àí D(D)|</em> (‚â§ 2,0 mm)</div>
            <div><strong>DDTM</strong> ‚Äî Diferen√ßa entre eixos do mesmo truque motor: <em>DDTM = |DÃÑeixo1 ‚àí DÃÑeixo2|</em> (‚â§ 2,0 mm)</div>
            <div><strong>DDTR</strong> ‚Äî Diferen√ßa entre eixos do truque reboque (NP): <em>DDTR = |DÃÑeixo1 ‚àí DÃÑeixo2|</em> (‚â§ 6,0 mm)</div>
            <div><strong>DDT</strong> ‚Äî M√°xima diferen√ßa par-a-par entre truques motores: <em>DDT = max(|DÃÑtruque_i ‚àí DÃÑtruque_j|)</em> (‚â§ 10,0 mm)</div>
            <hr style="border:none;border-top:1px solid #ddd;margin:10px 0" />
            <div><strong>Notas</strong></div>
            <div>‚Ä¢ <strong>DÃÑ_eixo</strong> = m√©dia de D(E) e D(D) no mesmo eixo.</div>
            <div>‚Ä¢ <strong>DÃÑ_truque</strong> = m√©dia dos dois eixos do truque.</div>
            <div>‚Ä¢ <strong>E</strong> = roda Esquerda (ref. Torno) | <strong>D</strong> = roda Direita (ref. Torno).</div>
            <div>‚Ä¢ Unidades: mm </div>
          </div>
        </div>
      `;

      const kmFmt = (!isNaN(data.meta.km))
        ? new Intl.NumberFormat("pt-BR").format(Number(data.meta.km))
        : "‚Äî";	

      const html=`
        <html>
          <head>
            <meta charset="utf-8" />
            <title>${base}</title>
            <style>
              body { font-family: Arial, sans-serif; color: #111; }
              .print-section { padding: 16px 24px; }
              .print-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 8px; }
              .print-sub { color: #555; margin-bottom: 12px; }
              .print-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
              .print-card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
              .print-table { width: 100%; border-collapse: collapse; }
              .print-table th, .print-table td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
              .print-table thead th { background: #f3f3f3; }
              .chips { display: flex; gap: 8px; flex-wrap: wrap; }
              .chip { border: 1px solid #ddd; border-radius: 999px; padding: 4px 10px; font-weight: 700; font-size: 12px; }

              .pdf-ok{ background:#e8f5e9; color:#1b5e20; }
              .pdf-warn{ background:#fff8e1; color:#8a5a00; }
              .pdf-bad{ background:#ffebee; color:#b71c1c; }
              .pdf-empty{ background:#fafafa; color:#777; }

              .status-dot{ display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:4px; border:1px solid rgba(0,0,0,.2); }
              .status-dot.ok{ background:#1b5e20; }
              .status-dot.warn{ background:#bf7b00; }
              .status-dot.bad{ background:#b71c1c; }
              .status-dot.empty{ background:#9aa0a6; }

              /* ‚úÖ ESSA √â A CORRE√á√ÉO: em impress√£o, estilizar os TDs (n√£o s√≥ o TR) */
              .print-table tr.pdf-derived-out td{
                background:#ffebee !important;
                color:#b71c1c !important;
                font-weight:700;
              }

              .legend {
                font-size: 12px;
                color: #222;
                line-height: 1.35;
              }
              .legend div {
                margin: 4px 0;
              }
              .legend em {
                font-style: italic;
                color: #333;
              }

            </style>
          </head>
          <body>
            <div class="print-section">
              <div class="print-title">Relat√≥rio consolidado ‚Äî Medi√ß√£o de Rodas</div>
              <div class="print-sub">Gerado em ${now.toLocaleString('pt-BR')}</div>

              <div class="print-card">
                <div class="print-grid">
                  <div><strong>Unidade:</strong> ${data.meta.unidade || "‚Äî"}</div>
                  <div><strong>Frota:</strong> ${data.meta.frota || "‚Äî"}</div>
                  <div><strong>Trem:</strong> ${data.meta.trem || "‚Äî"}</div>
                  <div><strong>Data:</strong> ${data.meta.data || "‚Äî"}</div>
                  <div><strong>OS:</strong> ${data.meta.os || "‚Äî"}</div>
                  <div><strong>KM:</strong> ${kmFmt}</div>
                  <div><strong>Opera√ß√£o:</strong> ${data.meta.operacao || "‚Äî"}</div>
                  <div><strong>Tipo:</strong> ${data.meta.tipo || "‚Äî"}</div>
                  <div><strong>Sentido:</strong> ${data.meta.sentido || "‚Äî"}</div>
                </div>
              </div>

              <div class="print-card">
                <div><strong>Contadores de far√≥is</strong></div>
                <div class="chips" style="margin-top:6px">
                  <span class="chip">Verde: ${counters.green}</span>
                  <span class="chip">Amarelo: ${counters.yellow}</span>
                  <span class="chip">Vermelho: ${counters.red}</span>
                  <span class="chip">Vazios: ${counters.empty}</span>
                </div>
              </div>

              <div class="print-card">
                <div><strong>Medi√ß√µes completas</strong></div>
                <table class="print-table" style="margin-top:6px">
                  <thead>${measuresHeader}</thead>
                  <tbody>${measuresRows || `<tr><td colspan="10">Sem dados</td></tr>`}</tbody>
                </table>
              </div>

              <div class="print-card">
                <div><strong>Resultados derivados</strong></div>
                <table class="print-table" style="margin-top:6px">
                  <thead><tr><th>Regra</th><th>Refer√™ncia</th><th>Valor</th><th>Status</th></tr></thead>
                  <tbody>${derivedRows || `<tr><td colspan="4">Sem dados</td></tr>`}</tbody>
                </table>
              </div>
	      ${legendaHtml}
            </div>
          </body>
        </html>
      `;

      const win=window.open("","_blank");
      win.document.open(); win.document.write(html); win.document.close();
      win.onload=()=>setTimeout(()=>win.print(),120);
    }

    /* =========================
       UI
       ========================= */
    document.getElementById("unidade").addEventListener("change",(e)=>{
      fillFrotaOptions(e.target.value);
      document.getElementById("frota").value="";
      updateFinalScore();
    });

    function onlyDigits(el){
      const prev = el.value;
      const next = String(prev).replace(/\D+/g, ""); // remove tudo que n√£o √© d√≠gito
      if (prev !== next) el.value = next;
    }

    // KM e OS: s√≥ d√≠gitos, inclusive quando colar texto
    ["km","os"].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener("input", () => onlyDigits(el));
      el.addEventListener("paste", () => setTimeout(()=>onlyDigits(el), 0));
    });

    ["frota","trem","data","km","os","operacao","tipo","sentido"].forEach(id=>{
      const el=document.getElementById(id);
      el.addEventListener("change",updateFinalScore);
      el.addEventListener("input",updateFinalScore);
    });

    document.getElementById("downloadCsvBtn").addEventListener("click",()=>{
      const data = collectData();
      downloadCSV(data);
      alertSuccess.textContent = "Exportado CSV com sucesso.";
      alertSuccess.style.display = "block";
    });

    // Mantive submit s√≥ como "valida√ß√£o leve" (sem alertError).
    document.getElementById("inspectionForm").addEventListener("submit",(e)=>{
      e.preventDefault();
      
      const data = collectData();
      const metaOK = isMetaFilled(data.meta);

      if(!metaOK){
    			alertSuccess.textContent="Preencha todo o cabe√ßalho antes de enviar (Unidade, Frota, Trem, Data, KM, OS, Opera√ß√£o, Tipo, Sentido).";
    			alertSuccess.style.display="block";
    			return;
  		}
	
      // 1) Baixa CSV com nome padr√£o (j√° usa buildExportBaseName)
  		downloadCSV(data);
      
       // 2) Abre janela do PDF (usu√°rio salva como PDF)
               generatePdfReport();

       // 3) Abre e-mail pronto (sem anexos autom√°ticos ‚Äî limita√ß√£o do browser)
       const to = "rafael.amaral@motiva.com.br";
       const subject = buildEmailSubject(data.meta);

       const base = buildExportBaseName(data.meta);
       const body =

    `Ol√°,

    Segue formul√°rio de medi√ß√£o de rodas.

    Arquivos gerados:
    - ${base}.csv
    - ${base}.pdf
	
    Unidade: ${data.meta.unidade}
    Trem ID: ${data.meta.trem}
    OS: ${data.meta.os}
    Opera√ß√£o: ${data.meta.operacao}
    Data: ${data.meta.data}

    (Anexos: CSV e PDF gerados pelo sistema.)

    Obrigado.`;


       const mailto = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
       window.location.href = mailto;
	
      alertSuccess.textContent="CSV baixado, PDF aberto para salvar e e-mail preparado. Anexe os dois arquivos e envie.";
      alertSuccess.style.display="block";
    });

    document.getElementById("generatePdfBtn").addEventListener("click",generatePdfReport);

    document.getElementById("sentido").addEventListener("change",()=>{
      updateRodaTremColumn();
      computeAndRenderDerived();
      updateCounters();
      updateFinalScore();
    });

    /* =========================
       Bot√£o "Roda Nova"
       ========================= */
    function preencherRodaNova() {
      const valoresRodaNova = { D:608.50, sD:22.20, sH:25.50, qR:4.99, FR:0.00, V:0.00 };

      document.querySelectorAll("input.measure-input").forEach(input => {
        const key = input.name.split("-").slice(-1)[0];
        if (Object.prototype.hasOwnProperty.call(valoresRodaNova, key)) {
          input.value = valoresRodaNova[key];
          input.dispatchEvent(new Event("input", { bubbles: true }));
        }
      });

      computeAndRenderDerived();
      updateCounters();
      updateFinalScore();
    }

    function atualizarEstadoBotaoRodaNova() {
      const operacao = document.getElementById("operacao").value;
      const btn = document.getElementById("rodaNovaBtn");
      btn.disabled = (operacao !== "Troca Roda");
    }

    document.getElementById("rodaNovaBtn").addEventListener("click", () => {
      if (document.getElementById("rodaNovaBtn").disabled) return;
      preencherRodaNova();
    });

    document.getElementById("operacao").addEventListener("change", () => {
      atualizarEstadoBotaoRodaNova();
      updateFinalScore();
    });

    document.getElementById("inspectionForm").addEventListener("reset",()=>{
      setTimeout(()=>{
        document.getElementById("unidade").value="";
        fillFrotaOptions(null);
        document.getElementById("frota").value="";

        atualizarEstadoBotaoRodaNova();
        updateRodaTremColumn();
        computeAndRenderDerived();
        updateCounters();
        updateFinalScore();

        alertSuccess.style.display="none";
      },0);
    });

    function updateRodaTremColumn(){
      const sentido=document.getElementById("sentido").value;
      [...tbody.querySelectorAll("tr")].forEach(tr=>{
        const ths=tr.querySelectorAll("th");
        const truque=ths[0].textContent;
        const eixo=Number(ths[1].textContent);
        const roda=ths[2].textContent;
        ths[3].textContent=getRodaTrem(truque,eixo,roda,sentido);
      });
    }

    function initAll(){
      fillTremOptions();
      fillFrotaOptions(null);
      initTable();
      updateRodaTremColumn();
      computeAndRenderDerived();
      updateCounters();
      updateFinalScore();
      atualizarEstadoBotaoRodaNova();
      bindMeasureTableAutoUpdates();
    }
    initAll();
  </script>
</body>
</html>
